{% extends "base.html" %}

{% block content %}
<div class="max-w-md mx-auto bg-white rounded-xl shadow-md overflow-hidden md:max-w-2xl p-6">
    {% if email %}
        <div class="text-center mb-8">
            <h1 class="text-2xl font-bold text-green-600 mb-4">Welcome!</h1>
            <div class="bg-gray-100 rounded-lg p-4">
                <p class="text-gray-700">Logged in as:</p>
                <p class="text-xl font-semibold text-gray-900">{{ email }}</p>
            </div>
        </div>

        <div id="profile-form" class="space-y-4">
            <h2 class="text-xl font-bold text-gray-800 mb-4">Edit Your Digital Business Card</h2>
            <div class="space-y-3">
                <div>
                    <label class="block text-sm font-medium text-gray-700">Full Name</label>
                    <input type="text" id="full_name" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Phone</label>
                    <input type="tel" id="phone" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Title</label>
                    <input type="text" id="title" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Company</label>
                    <input type="text" id="company" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Website</label>
                    <input type="url" id="website" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Address</label>
                    <textarea id="address" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500"></textarea>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Notes</label>
                    <textarea id="notes" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500"></textarea>
                </div>
                <div class="pt-4">
                    <button onclick="saveProfile()" class="w-full bg-green-600 text-white py-2 px-4 rounded-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2">
                        Save Changes
                    </button>
                </div>
            </div>
        </div>

        <script>
            // Load profile data when page loads
            async function loadProfile() {
                try {
                    const response = await fetch('/api/profile');
                    if (response.ok) {
                        const data = await response.json();
                        Object.keys(data).forEach(key => {
                            const element = document.getElementById(key);
                            if (element) {
                                element.value = data[key] || '';
                            }
                        });
                    }
                } catch (error) {
                    console.error('Error loading profile:', error);
                }
            }

            // Save profile data
            async function saveProfile() {
                const fields = ['full_name', 'phone', 'title', 'company', 'website', 'address', 'notes'];
                const data = {};
                fields.forEach(field => {
                    const element = document.getElementById(field);
                    if (element) {
                        data[field] = element.value;
                    }
                });

                try {
                    const response = await fetch('/api/profile', {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(data)
                    });

                    if (response.ok) {
                        alert('Profile updated successfully!');
                    } else {
                        alert('Error updating profile. Please try again.');
                    }
                } catch (error) {
                    console.error('Error saving profile:', error);
                    alert('Error updating profile. Please try again.');
                }
            }

            // Load profile data when page loads
            document.addEventListener('DOMContentLoaded', loadProfile);
        </script>
    {% else %}
        <div class="text-center">
            <h1 class="text-2xl font-bold text-red-600 mb-4">Authentication Required</h1>
            <p class="text-gray-700">Please log in through Cloudflare Access to continue.</p>
        </div>
    {% endif %}
</div>
{% endblock %}